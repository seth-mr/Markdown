"use strict";var e=require("obsidian"),t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},t(e,n)};function n(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}function r(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{a(r.next(e))}catch(e){o(e)}}function l(e){try{a(r.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,l)}a((r=r.apply(e,t||[])).next())}))}function i(e,t){var n,r,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=l(0),s.throw=l(1),s.return=l(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function l(l){return function(a){return function(l){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,l[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&l[0]?r.return:l[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,l[1])).done)return i;switch(r=0,i&&(l=[2&l[0],i.value]),l[0]){case 0:case 1:i=l;break;case 4:return o.label++,{value:l[1],done:!1};case 5:o.label++,r=l[1],l=[0];continue;case 7:l=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==l[0]&&2!==l[0])){o=0;continue}if(3===l[0]&&(!i||l[1]>i[0]&&l[1]<i[3])){o.label=l[1];break}if(6===l[0]&&o.label<i[1]){o.label=i[1],i=l;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(l);break}i[2]&&o.ops.pop(),o.trys.pop();continue}l=t.call(e,o)}catch(e){l=[6,e],r=0}finally{n=i=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([l,a])}}}function o(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function s(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,i,o=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)s.push(r.value)}catch(e){i={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return s}function l(e,t,n){if(n||2===arguments.length)for(var r,i=0,o=t.length;i<o;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))}function a(e){return this instanceof a?(this.v=e,this):new a(e)}function c(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,i=n.apply(e,t||[]),o=[];return r=Object.create(("function"==typeof AsyncIterator?AsyncIterator:Object).prototype),s("next"),s("throw"),s("return",(function(e){return function(t){return Promise.resolve(t).then(e,u)}})),r[Symbol.asyncIterator]=function(){return this},r;function s(e,t){i[e]&&(r[e]=function(t){return new Promise((function(n,r){o.push([e,t,n,r])>1||l(e,t)}))},t&&(r[e]=t(r[e])))}function l(e,t){try{(n=i[e](t)).value instanceof a?Promise.resolve(n.value.v).then(c,u):d(o[0][2],n)}catch(e){d(o[0][3],e)}var n}function c(e){l("next",e)}function u(e){l("throw",e)}function d(e,t){e(t),o.shift(),o.length&&l(o[0][0],o[0][1])}}function u(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e=o(e),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(n){t[n]=e[n]&&function(t){return new Promise((function(r,i){(function(e,t,n,r){Promise.resolve(r).then((function(t){e({value:t,done:n})}),t)})(r,i,(t=e[n](t)).done,t.value)}))}}}function d(e){return"function"==typeof e}function h(e){return function(t){if(function(e){return d(null==e?void 0:e.lift)}(t))return t.lift((function(t){try{return e(t,this)}catch(e){this.error(e)}}));throw new TypeError("Unable to lift unknown Observable type")}}"function"==typeof SuppressedError&&SuppressedError;var p=function(e){return e&&"number"==typeof e.length&&"function"!=typeof e};function g(e){return d(null==e?void 0:e.then)}function f(e){var t=e((function(e){Error.call(e),e.stack=(new Error).stack}));return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}var v=f((function(e){return function(t){e(this),this.message=t?t.length+" errors occurred during unsubscription:\n"+t.map((function(e,t){return t+1+") "+e.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=t}}));function b(e,t){if(e){var n=e.indexOf(t);0<=n&&e.splice(n,1)}}var m=function(){function e(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}var t;return e.prototype.unsubscribe=function(){var e,t,n,r,i;if(!this.closed){this.closed=!0;var a=this._parentage;if(a)if(this._parentage=null,Array.isArray(a))try{for(var c=o(a),u=c.next();!u.done;u=c.next()){u.value.remove(this)}}catch(t){e={error:t}}finally{try{u&&!u.done&&(t=c.return)&&t.call(c)}finally{if(e)throw e.error}}else a.remove(this);var h=this.initialTeardown;if(d(h))try{h()}catch(e){i=e instanceof v?e.errors:[e]}var p=this._finalizers;if(p){this._finalizers=null;try{for(var g=o(p),f=g.next();!f.done;f=g.next()){var b=f.value;try{w(b)}catch(e){i=null!=i?i:[],e instanceof v?i=l(l([],s(i)),s(e.errors)):i.push(e)}}}catch(e){n={error:e}}finally{try{f&&!f.done&&(r=g.return)&&r.call(g)}finally{if(n)throw n.error}}}if(i)throw new v(i)}},e.prototype.add=function(t){var n;if(t&&t!==this)if(this.closed)w(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=null!==(n=this._finalizers)&&void 0!==n?n:[]).push(t)}},e.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},e.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},e.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&b(t,e)},e.prototype.remove=function(t){var n=this._finalizers;n&&b(n,t),t instanceof e&&t._removeParent(this)},e.EMPTY=((t=new e).closed=!0,t),e}(),C=m.EMPTY;function y(e){return e instanceof m||e&&"closed"in e&&d(e.remove)&&d(e.add)&&d(e.unsubscribe)}function w(e){d(e)?e():e.unsubscribe()}var T={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},S=function(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];return setTimeout.apply(void 0,l([e,t],s(n)))};function k(e){S((function(){throw e}))}function x(){}function E(e){e()}var I=function(e){function t(t){var n=e.call(this)||this;return n.isStopped=!1,t?(n.destination=t,y(t)&&t.add(n)):n.destination=O,n}return n(t,e),t.create=function(e,t,n){return new D(e,t,n)},t.prototype.next=function(e){this.isStopped||this._next(e)},t.prototype.error=function(e){this.isStopped||(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){try{this.destination.error(e)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(m),P=Function.prototype.bind;function L(e,t){return P.call(e,t)}var A=function(){function e(e){this.partialObserver=e}return e.prototype.next=function(e){var t=this.partialObserver;if(t.next)try{t.next(e)}catch(e){M(e)}},e.prototype.error=function(e){var t=this.partialObserver;if(t.error)try{t.error(e)}catch(e){M(e)}else M(e)},e.prototype.complete=function(){var e=this.partialObserver;if(e.complete)try{e.complete()}catch(e){M(e)}},e}(),D=function(e){function t(t,n,r){var i,o,s=e.call(this)||this;d(t)||!t?i={next:null!=t?t:void 0,error:null!=n?n:void 0,complete:null!=r?r:void 0}:s&&T.useDeprecatedNextContext?((o=Object.create(t)).unsubscribe=function(){return s.unsubscribe()},i={next:t.next&&L(t.next,o),error:t.error&&L(t.error,o),complete:t.complete&&L(t.complete,o)}):i=t;return s.destination=new A(i),s}return n(t,e),t}(I);function M(e){k(e)}var O={closed:!0,next:x,error:function(e){throw e},complete:x},_="function"==typeof Symbol&&Symbol.observable||"@@observable";function V(e){return e}var B=function(){function e(e){e&&(this._subscribe=e)}return e.prototype.lift=function(t){var n=new e;return n.source=this,n.operator=t,n},e.prototype.subscribe=function(e,t,n){var r,i=this,o=(r=e)&&r instanceof I||function(e){return e&&d(e.next)&&d(e.error)&&d(e.complete)}(r)&&y(r)?e:new D(e,t,n);return E((function(){var e=i,t=e.operator,n=e.source;o.add(t?t.call(o,n):n?i._subscribe(o):i._trySubscribe(o))})),o},e.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){e.error(t)}},e.prototype.forEach=function(e,t){var n=this;return new(t=N(t))((function(t,r){var i=new D({next:function(t){try{e(t)}catch(e){r(e),i.unsubscribe()}},error:r,complete:t});n.subscribe(i)}))},e.prototype._subscribe=function(e){var t;return null===(t=this.source)||void 0===t?void 0:t.subscribe(e)},e.prototype[_]=function(){return this},e.prototype.pipe=function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return(0===(e=t).length?V:1===e.length?e[0]:function(t){return e.reduce((function(e,t){return t(e)}),t)})(this)},e.prototype.toPromise=function(e){var t=this;return new(e=N(e))((function(e,n){var r;t.subscribe((function(e){return r=e}),(function(e){return n(e)}),(function(){return e(r)}))}))},e.create=function(t){return new e(t)},e}();function N(e){var t;return null!==(t=null!=e?e:T.Promise)&&void 0!==t?t:Promise}function $(e){return d(e[_])}function U(e){return Symbol.asyncIterator&&d(null==e?void 0:e[Symbol.asyncIterator])}function F(e){return new TypeError("You provided "+(null!==e&&"object"==typeof e?"an invalid object":"'"+e+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}var j="function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator";function R(e){return d(null==e?void 0:e[j])}function z(e){return c(this,arguments,(function(){var t,n,r;return i(this,(function(i){switch(i.label){case 0:t=e.getReader(),i.label=1;case 1:i.trys.push([1,,9,10]),i.label=2;case 2:return[4,a(t.read())];case 3:return n=i.sent(),r=n.value,n.done?[4,a(void 0)]:[3,5];case 4:return[2,i.sent()];case 5:return[4,a(r)];case 6:return[4,i.sent()];case 7:return i.sent(),[3,2];case 8:return[3,10];case 9:return t.releaseLock(),[7];case 10:return[2]}}))}))}function H(e){return d(null==e?void 0:e.getReader)}function Q(e){if(e instanceof B)return e;if(null!=e){if($(e))return i=e,new B((function(e){var t=i[_]();if(d(t.subscribe))return t.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")}));if(p(e))return r=e,new B((function(e){for(var t=0;t<r.length&&!e.closed;t++)e.next(r[t]);e.complete()}));if(g(e))return n=e,new B((function(e){n.then((function(t){e.closed||(e.next(t),e.complete())}),(function(t){return e.error(t)})).then(null,k)}));if(U(e))return W(e);if(R(e))return t=e,new B((function(e){var n,r;try{for(var i=o(t),s=i.next();!s.done;s=i.next()){var l=s.value;if(e.next(l),e.closed)return}}catch(e){n={error:e}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}e.complete()}));if(H(e))return W(z(e))}var t,n,r,i;throw F(e)}function W(e){return new B((function(t){(function(e,t){var n,o,s,l;return r(this,void 0,void 0,(function(){var r,a;return i(this,(function(i){switch(i.label){case 0:i.trys.push([0,5,6,11]),n=u(e),i.label=1;case 1:return[4,n.next()];case 2:if((o=i.sent()).done)return[3,4];if(r=o.value,t.next(r),t.closed)return[2];i.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return a=i.sent(),s={error:a},[3,11];case 6:return i.trys.push([6,,9,10]),o&&!o.done&&(l=n.return)?[4,l.call(n)]:[3,8];case 7:i.sent(),i.label=8;case 8:return[3,10];case 9:if(s)throw s.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}}))}))})(e,t).catch((function(e){return t.error(e)}))}))}function G(e,t,n,r,i){return new q(e,t,n,r,i)}var q=function(e){function t(t,n,r,i,o,s){var l=e.call(this,t)||this;return l.onFinalize=o,l.shouldUnsubscribe=s,l._next=n?function(e){try{n(e)}catch(e){t.error(e)}}:e.prototype._next,l._error=i?function(e){try{i(e)}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._error,l._complete=r?function(){try{r()}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._complete,l}return n(t,e),t.prototype.unsubscribe=function(){var t;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var n=this.closed;e.prototype.unsubscribe.call(this),!n&&(null===(t=this.onFinalize)||void 0===t||t.call(this))}},t}(I);function Y(e){return e[e.length-1]}function Z(e){return d(Y(e))?e.pop():void 0}function J(e){return(t=Y(e))&&d(t.schedule)?e.pop():void 0;var t}function X(e,t,n,r,i){void 0===r&&(r=0),void 0===i&&(i=!1);var o=t.schedule((function(){n(),i?e.add(this.schedule(null,r)):this.unsubscribe()}),r);if(e.add(o),!i)return o}function K(e){return h((function(t,n){var r,i=null,o=!1;i=t.subscribe(G(n,void 0,void 0,(function(s){r=Q(e(s,K(e)(t))),i?(i.unsubscribe(),i=null,r.subscribe(n)):o=!0}))),o&&(i.unsubscribe(),i=null,r.subscribe(n))}))}var ee=Array.isArray,te=Object.getPrototypeOf,ne=Object.prototype,re=Object.keys;function ie(e){if(1===e.length){var t=e[0];if(ee(t))return{args:t,keys:null};if((r=t)&&"object"==typeof r&&te(r)===ne){var n=re(t);return{args:n.map((function(e){return t[e]})),keys:n}}}var r;return{args:e,keys:null}}function oe(e,t){return void 0===t&&(t=0),h((function(n,r){n.subscribe(G(r,(function(n){return X(r,e,(function(){return r.next(n)}),t)}),(function(){return X(r,e,(function(){return r.complete()}),t)}),(function(n){return X(r,e,(function(){return r.error(n)}),t)})))}))}function se(e,t){return void 0===t&&(t=0),h((function(n,r){r.add(e.schedule((function(){return n.subscribe(r)}),t))}))}function le(e,t){if(!e)throw new Error("Iterable cannot be null");return new B((function(n){X(n,t,(function(){var r=e[Symbol.asyncIterator]();X(n,t,(function(){r.next().then((function(e){e.done?n.complete():n.next(e.value)}))}),0,!0)}))}))}function ae(e,t){if(null!=e){if($(e))return function(e,t){return Q(e).pipe(se(t),oe(t))}(e,t);if(p(e))return function(e,t){return new B((function(n){var r=0;return t.schedule((function(){r===e.length?n.complete():(n.next(e[r++]),n.closed||this.schedule())}))}))}(e,t);if(g(e))return function(e,t){return Q(e).pipe(se(t),oe(t))}(e,t);if(U(e))return le(e,t);if(R(e))return function(e,t){return new B((function(n){var r;return X(n,t,(function(){r=e[j](),X(n,t,(function(){var e,t,i;try{t=(e=r.next()).value,i=e.done}catch(e){return void n.error(e)}i?n.complete():n.next(t)}),0,!0)})),function(){return d(null==r?void 0:r.return)&&r.return()}}))}(e,t);if(H(e))return function(e,t){return le(z(e),t)}(e,t)}throw F(e)}function ce(e,t){return t?ae(e,t):Q(e)}function ue(e,t){return h((function(n,r){var i=0;n.subscribe(G(r,(function(n){r.next(e.call(t,n,i++))})))}))}var de=Array.isArray;function he(e){return ue((function(t){return function(e,t){return de(t)?e.apply(void 0,l([],s(t))):e(t)}(e,t)}))}function pe(e,t){return e.reduce((function(e,n,r){return e[n]=t[r],e}),{})}function ge(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=J(e),r=Z(e),i=ie(e),o=i.args,s=i.keys;if(0===o.length)return ce([],n);var l=new B(function(e,t,n){void 0===n&&(n=V);return function(r){fe(t,(function(){for(var i=e.length,o=new Array(i),s=i,l=i,a=function(i){fe(t,(function(){var a=ce(e[i],t),c=!1;a.subscribe(G(r,(function(e){o[i]=e,c||(c=!0,l--),l||r.next(n(o.slice()))}),(function(){--s||r.complete()})))}),r)},c=0;c<i;c++)a(c)}),r)}}(o,n,s?function(e){return pe(s,e)}:V));return r?l.pipe(he(r)):l}function fe(e,t,n){e?X(n,e,t):t()}function ve(e,t,n){return void 0===n&&(n=1/0),d(t)?ve((function(n,r){return ue((function(e,i){return t(n,e,r,i)}))(Q(e(n,r)))}),n):("number"==typeof t&&(n=t),h((function(t,r){return function(e,t,n,r,i,o,s,l){var a=[],c=0,u=0,d=!1,h=function(){!d||a.length||c||t.complete()},p=function(e){return c<r?g(e):a.push(e)},g=function(e){o&&t.next(e),c++;var l=!1;Q(n(e,u++)).subscribe(G(t,(function(e){null==i||i(e),o?p(e):t.next(e)}),(function(){l=!0}),void 0,(function(){if(l)try{c--;for(var e=function(){var e=a.shift();s?X(t,s,(function(){return g(e)})):g(e)};a.length&&c<r;)e();h()}catch(e){t.error(e)}})))};return e.subscribe(G(t,p,(function(){d=!0,h()}))),function(){null==l||l()}}(t,r,e,n)})))}function be(){return void 0===(e=1)&&(e=1/0),ve(V,e);var e}function me(e,t){return d(t)?ve(e,t,1):ve(e,1)}var Ce=f((function(e){return function(){e(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}})),ye=function(e){function t(){var t=e.call(this)||this;return t.closed=!1,t.currentObservers=null,t.observers=[],t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return n(t,e),t.prototype.lift=function(e){var t=new we(this,this);return t.operator=e,t},t.prototype._throwIfClosed=function(){if(this.closed)throw new Ce},t.prototype.next=function(e){var t=this;E((function(){var n,r;if(t._throwIfClosed(),!t.isStopped){t.currentObservers||(t.currentObservers=Array.from(t.observers));try{for(var i=o(t.currentObservers),s=i.next();!s.done;s=i.next()){s.value.next(e)}}catch(e){n={error:e}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}}}))},t.prototype.error=function(e){var t=this;E((function(){if(t._throwIfClosed(),!t.isStopped){t.hasError=t.isStopped=!0,t.thrownError=e;for(var n=t.observers;n.length;)n.shift().error(e)}}))},t.prototype.complete=function(){var e=this;E((function(){if(e._throwIfClosed(),!e.isStopped){e.isStopped=!0;for(var t=e.observers;t.length;)t.shift().complete()}}))},t.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(t.prototype,"observed",{get:function(){var e;return(null===(e=this.observers)||void 0===e?void 0:e.length)>0},enumerable:!1,configurable:!0}),t.prototype._trySubscribe=function(t){return this._throwIfClosed(),e.prototype._trySubscribe.call(this,t)},t.prototype._subscribe=function(e){return this._throwIfClosed(),this._checkFinalizedStatuses(e),this._innerSubscribe(e)},t.prototype._innerSubscribe=function(e){var t=this,n=this,r=n.hasError,i=n.isStopped,o=n.observers;return r||i?C:(this.currentObservers=null,o.push(e),new m((function(){t.currentObservers=null,b(o,e)})))},t.prototype._checkFinalizedStatuses=function(e){var t=this,n=t.hasError,r=t.thrownError,i=t.isStopped;n?e.error(r):i&&e.complete()},t.prototype.asObservable=function(){var e=new B;return e.source=this,e},t.create=function(e,t){return new we(e,t)},t}(B),we=function(e){function t(t,n){var r=e.call(this)||this;return r.destination=t,r.source=n,r}return n(t,e),t.prototype.next=function(e){var t,n;null===(n=null===(t=this.destination)||void 0===t?void 0:t.next)||void 0===n||n.call(t,e)},t.prototype.error=function(e){var t,n;null===(n=null===(t=this.destination)||void 0===t?void 0:t.error)||void 0===n||n.call(t,e)},t.prototype.complete=function(){var e,t;null===(t=null===(e=this.destination)||void 0===e?void 0:e.complete)||void 0===t||t.call(e)},t.prototype._subscribe=function(e){var t,n;return null!==(n=null===(t=this.source)||void 0===t?void 0:t.subscribe(e))&&void 0!==n?n:C},t}(ye);var Te=new B((function(e){return e.complete()}));function Se(e){return e<=0?function(){return Te}:h((function(t,n){var r=0;t.subscribe(G(n,(function(t){++r<=e&&(n.next(t),e<=r&&n.complete())})))}))}function ke(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return ce(e,J(e))}function xe(e,t){var n=d(e)?e:function(){return e},r=function(e){return e.error(n())};return new B(t?function(e){return t.schedule(r,0,e)}:r)}function Ee(e,t){return h((function(n,r){var i=0;n.subscribe(G(r,(function(n){return e.call(t,n,i++)&&r.next(n)})))}))}function Ie(e){return h((function(t,n){try{t.subscribe(n)}finally{n.add(e)}}))}var Pe,Le,Ae,De,Me,Oe,_e,Ve=function(e){function t(t){var n=e.call(this)||this;return n._value=t,n}return n(t,e),Object.defineProperty(t.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),t.prototype._subscribe=function(t){var n=e.prototype._subscribe.call(this,t);return!n.closed&&t.next(this._value),n},t.prototype.getValue=function(){var e=this,t=e.hasError,n=e.thrownError,r=e._value;if(t)throw n;return this._throwIfClosed(),r},t.prototype.next=function(t){e.prototype.next.call(this,this._value=t)},t}(ye);function Be(e,t){return h((function(n,r){var i=null,o=0,s=!1,l=function(){return s&&!i&&r.complete()};n.subscribe(G(r,(function(n){null==i||i.unsubscribe();var s=0,a=o++;Q(e(n,a)).subscribe(i=G(r,(function(e){return r.next(t?t(n,e,a,s++):e)}),(function(){i=null,l()})))}),(function(){s=!0,l()})))}))}function Ne(e){return h((function(t,n){Q(e).subscribe(G(n,(function(){return n.complete()}),x)),!n.closed&&t.subscribe(n)}))}function $e(e,t,n){var r=d(e)||t||n?{next:e,error:t,complete:n}:e;return r?h((function(e,t){var n;null===(n=r.subscribe)||void 0===n||n.call(r);var i=!0;e.subscribe(G(t,(function(e){var n;null===(n=r.next)||void 0===n||n.call(r,e),t.next(e)}),(function(){var e;i=!1,null===(e=r.complete)||void 0===e||e.call(r),t.complete()}),(function(e){var n;i=!1,null===(n=r.error)||void 0===n||n.call(r,e),t.error(e)}),(function(){var e,t;i&&(null===(e=r.unsubscribe)||void 0===e||e.call(r)),null===(t=r.finalize)||void 0===t||t.call(r)})))})):V}!function(e){e.NoToken="NoToken",e.Unauthorized="Unauthorized",e.RateLimit="RateLimit",e.Unknown="Unknown",e.Abort="Abort"}(Pe||(Pe={})),function(e){e.Left="left",e.Right="right"}(Le||(Le={})),function(e){e.Comment="commentCard"}(Ae||(Ae={})),function(e){e.Complete="complete",e.Incomplete="incomplete"}(De||(De={})),function(e){e.Green="green",e.Yellow="yellow",e.Orange="orange",e.Red="red",e.Purple="purple",e.Blue="blue",e.Sky="sky",e.Lime="lime",e.Pink="pink",e.Black="black"}(Me||(Me={})),function(e){e.Top="top",e.Bottom="bottom"}(Oe||(Oe={})),function(e){e[e.Info=0]="Info",e[e.Warn=1]="Warn",e[e.Error=2]="Error"}(_e||(_e={}));const Ue={id:"trello-plugin-icon-trello",svgContent:'<g><path fill="currentColor" stroke="currentColor" style="stroke:none;fill-rule:nonzero;fill-opacity:1;" d="M 82 8 L 18 8 C 12.480469 8 8 12.480469 8 18 L 8 82 C 8 87.519531 12.480469 92 18 92 L 82 92 C 87.519531 92 92 87.519531 92 82 L 92 18 C 92 12.480469 87.519531 8 82 8 Z M 42 72 C 42 74.199219 40.199219 76 38 76 L 24 76 C 21.800781 76 20 74.199219 20 72 L 20 24 C 20 21.800781 21.800781 20 24 20 L 38 20 C 40.199219 20 42 21.800781 42 24 Z M 80 48 C 80 50.199219 78.199219 52 76 52 L 62 52 C 59.800781 52 58 50.199219 58 48 L 58 24 C 58 21.800781 59.800781 20 62 20 L 76 20 C 78.199219 20 80 21.800781 80 24 Z M 80 48 "/></g>'},Fe="https://api.trello.com",je="trello-plugin",Re="The Trello plugin requires an API token for use. Please visit plugin settings.",ze="The Trello API is rate limited. Please try again later.",He="The Trello API rejected your token. Please create a new token.",Qe="The Trello API could not be reached. Please create a new token or try again later.",We="global",Ge={token:"",customUi:{global:{checklists:!0,comments:!0,description:!0,labels:!0,list:!0,title:!0,due:!0}},selectedBoards:[],openToSide:Le.Right,newCardPosition:Oe.Top,movedCardPosition:Oe.Top,verboseLogging:!1,prepopulateTitle:!1,openInDesktop:!1},qe={settings:Ge,version:"2.3.2",firstRun:!0,connectedCards:{}};var Ye;!function(e){e.BoardCard="trello_board_card_id",e.TrelloId="trello_plugin_note_id"}(Ye||(Ye={}));const Ze={name:"Create a new card...",id:"CREATE_NEW_TRELLO_CARD"};function Je(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=Z(e),r=ie(e),i=r.args,o=r.keys,s=new B((function(e){var t=i.length;if(t)for(var n=new Array(t),r=t,s=t,l=function(t){var l=!1;Q(i[t]).subscribe(G(e,(function(e){l||(l=!0,s--),n[t]=e}),(function(){return r--}),void 0,(function(){r&&l||(s||e.next(o?pe(o,n):n),e.complete())})))},a=0;a<t;a++)l(a);else e.complete()}));return n?s.pipe(he(n)):s}function Xe(e,t,n){return r=function(){return e()?t:n},new B((function(e){Q(r()).subscribe(e)}));var r}class Ke extends e.Modal{constructor(e,t){super(e),this.plugin=t,this.selectedBoards=this.plugin.state.settings.pipe(Se(1),ue((e=>e.selectedBoards?e.selectedBoards:[]))),this.newState={}}onOpen(){this.contentEl.empty(),Je({selected:this.selectedBoards,boards:this.plugin.api.getBoards()}).subscribe({next:({selected:e,boards:t})=>{const n=this.contentEl.createDiv("trello-board-select--container");n.createEl("h2",{text:"Boards",cls:"trello-board-select--title"}),this.newState={},e.forEach((e=>{this.newState[e.id]=e})),t.forEach((e=>{this.buildToggle(e,n)}));const r=this.contentEl.createDiv("trello-board-select--controls");r.createEl("button",{text:"Save",cls:"mod-cta"}).addEventListener("click",(()=>{this.onSave()}));r.createEl("button",{text:"Cancel"}).addEventListener("click",(()=>{this.close()}))},error:()=>{if(this.plugin.state.getSetting("token"))new e.Notice(Qe),this.close();else{this.contentEl.createDiv({cls:"trello-board-select--empty-state",text:"An API token is required."}).createEl("button",{text:"Setup Trello"}).addEventListener("click",(()=>{this.plugin.openTrelloSettings(),this.close()}))}}})}onClose(){this.contentEl.empty()}buildToggle(e,t){const n=t.createDiv("trello-board-select--toggle-container");n.createDiv({text:e.name,cls:"trello-board-select--toggle-label"});const r=n.createDiv({cls:"trello-board-select--toggle checkbox-container"});this.newState[e.id]&&r.addClass("is-enabled"),n.addEventListener("click",(()=>{this.newState[e.id]?(r.removeClass("is-enabled"),delete this.newState[e.id]):(r.addClass("is-enabled"),this.newState[e.id]=e)}))}onSave(){const e=Object.values(this.newState);this.plugin.state.updateSetting("selectedBoards",e),this.close()}}class et extends e.SuggestModal{constructor(e){super(e),this.selected=new ye,this.options=[],this.selectionMade=!1}onOpen(){this.selectionMade=!1,super.onOpen()}onClose(){this.selectionMade||(this.selected.error(Pe.Abort),this.selected.complete(),this.selected=new ye),super.onClose()}selectSuggestion(e,t){this.selectionMade=!0,super.selectSuggestion(e,t)}onChooseSuggestion(e){this.selected.next(e),this.selected.complete(),this.selected=new ye}}class tt extends et{constructor(e){super(e),this.setInstructions([{command:"",purpose:"Select a Trello board"}])}getSuggestions(e){const t=e.toLowerCase();return this.options.filter((e=>e.name.toLowerCase().includes(t)))}renderSuggestion(e,t){t.setText(e.name)}}const nt="trello-accordion--expanded";class rt{constructor(e,t=!0){this.parent=e,this.openOne=t,this.sections=[]}addSection(t){const n=this.parent.createDiv("trello-accordion--container"),r=n.createDiv("trello-accordion--title");r.createSpan({text:t,cls:"trello-accordion--title-text"});const i=r.createSpan("trello-accordion--title-icon");e.setIcon(i,"left-chevron-glyph");const o=n.createDiv("trello-accordion--content"),s={containerEl:n,titleEl:r,titleIcon:i,contentEl:o,expanded:!1};return s.titleEl.addEventListener("click",(()=>{s.expanded?this.collapseSection(s):this.expandSection(s)})),this.sections.push(s),s}expandSection(e){this.openOne&&this.sections.forEach((t=>{t!==e&&this.collapseSection(t)})),e.expanded=!0,e.titleIcon.addClass(nt),e.contentEl.style.maxHeight=e.contentEl.scrollHeight+"px"}collapseSection(e){e.expanded=!1,e.titleIcon.removeClass(nt),e.contentEl.style.maxHeight=""}}class it extends e.Modal{constructor(e,t){super(e),this.plugin=t,this.labels=[],this.createdCard=new ye,this.selectedLabels={},this.finishedCardCreation=!1}onOpen(){this.contentEl.empty();const e=this.contentEl.createDiv();this.title=this.renderTitle(e);const t=new rt(e),n=t.addSection("Description"),r=t.addSection("Labels");this.description=this.renderDescription(n.contentEl),this.due=this.renderDue(e),this.renderLabels(r.contentEl),this.position=this.renderPositionSelect(e);const i=e.createDiv("trello-card-create--controls");i.createEl("button",{text:"Save",cls:"mod-cta"}).addEventListener("click",this.onSave.bind(this));i.createEl("button",{text:"Cancel"}).addEventListener("click",this.close.bind(this))}onClose(){this.finishedCardCreation||this.createdCard.error(Pe.Abort),this.reset()}onSave(){let e;this.due.value&&(e=new Date(this.due.value).toISOString().toString()),this.plugin.api.addNewCard({idList:this.list.id,idLabels:Object.values(this.selectedLabels).map((e=>e.id)),name:this.title.value,desc:this.description.value,due:e,pos:this.position.value}).pipe(ue((e=>e.response))).subscribe({next:e=>{this.finishedCardCreation=!0,this.createdCard.next(e),this.close()},error:e=>{this.finishedCardCreation=!0,this.createdCard.error(e)}})}reset(){this.selectedLabels={},this.createdCard=new ye,this.title.value="",this.description.value="",this.due.value="",this.finishedCardCreation=!1}renderTitle(e){const t=e.createEl("input",{cls:"trello-card-create--title",attr:{placeholder:"Enter a title for this card..."}});if(!0===this.plugin.state.getSetting("prepopulateTitle")){const e=this.app.workspace.getActiveFile();e&&(t.value=e.name.replace(/\.[^/.]+$/,""))}return t}renderDescription(e){return e.createDiv("trello-card-create--desc-wrapper").createDiv({cls:"trello-card-create--desc-container"}).createEl("textarea",{cls:"trello-card-create--desc",attr:{onInput:"this.parentNode.dataset.replicatedValue = this.value",placeholder:"Add a more detailed description..."}})}renderDue(e){return e.createEl("input",{type:"datetime-local",cls:"trello-card-create--due",attr:{placeholder:"Due date for this card..."}})}renderLabels(e){const t=e.createDiv("trello-card-create--labels");this.labels.forEach((e=>{this.renderLabel(e,t)}))}renderLabel(e,t){const n=t.createDiv("trello-card-create--label-container");e.color?n.addClass(`label-color--${e.color}`):n.addClass("label-color--grey"),n.createSpan({text:e.name,cls:"trello-card-create--label-name"}),this.buildCheck(e,n)}buildCheck(t,n){const r=n.createSpan({cls:"trello-card-create--check"});n.addEventListener("click",(()=>{this.selectedLabels[t.id]?(r.empty(),delete this.selectedLabels[t.id]):(e.setIcon(r,"checkbox-glyph"),this.selectedLabels[t.id]=t)}))}renderPositionSelect(e){const t=e.createDiv("trello-card-create--position-select-container");t.createEl("label",{text:"Add new card to",attr:{for:"trello-card-create--position-select"}});const n=t.createEl("select",{cls:"dropdown",attr:{id:"trello-card-create--position-select"}});return n.createEl("option",{text:"Top",attr:{value:Oe.Top}}),n.createEl("option",{text:"Bottom",attr:{value:Oe.Bottom}}),n.value=this.defaultPosition,n}}class ot extends et{constructor(e){super(e),this.setInstructions([{command:"",purpose:"Select a Trello card"}])}getSuggestions(e){const t=e.toLowerCase();return[Ze,...this.options.filter((e=>e.name.toLowerCase().includes(t)))]}renderSuggestion(e,t){t.setText(e.name)}}class st extends e.Modal{constructor(t,n){super(t),this.plugin=n,this.source=new Ve(null),ge({customUi:this.plugin.state.settings.pipe(Ne(this.plugin.destroy),ue((e=>e.customUi))),source:this.source.pipe(Ee((e=>null!==e)),Ne(this.plugin.destroy))}).pipe(ue((({customUi:e,source:t})=>e[t]?(this.plugin.log("CustomizeUIModal",`Customizing ui config for trello ID ${t}`),e[t]):(this.plugin.log("CustomizeUIModal","Customizing global UI config"),e[We])))).subscribe((t=>{this.plugin.log("CustomizeUIModal","Building Customize UI modal");const n=this.source.value;this.contentEl.empty(),this.newState=Object.assign({},t),new e.Setting(this.contentEl).setName("Title").addToggle((e=>{e.setValue(t.title).onChange((e=>this.newState.title=e))})),new e.Setting(this.contentEl).setName("Description").addToggle((e=>{e.setValue(t.description).onChange((e=>this.newState.description=e))})),new e.Setting(this.contentEl).setName("Due").addToggle((e=>{e.setValue(t.due).onChange((e=>this.newState.due=e))})),new e.Setting(this.contentEl).setName("List").addToggle((e=>{e.setValue(t.list).onChange((e=>this.newState.list=e))})),new e.Setting(this.contentEl).setName("Comments").addToggle((e=>{e.setValue(t.comments).onChange((e=>this.newState.comments=e))})),new e.Setting(this.contentEl).setName("Labels").addToggle((e=>{e.setValue(t.labels).onChange((e=>this.newState.labels=e))})),new e.Setting(this.contentEl).setName("Checklists").addToggle((e=>{e.setValue(t.checklists).onChange((e=>this.newState.checklists=e))}));const r=this.contentEl.createDiv();if(n!==We){r.createEl("button",{text:"Reset to Default"}).addEventListener("click",(()=>{this.plugin.log("CustomizeUIModal",`Resetting UI config for trello ID ${n}`),this.plugin.state.updateCustomUI(n,null),this.plugin.view.updateCard(),this.close()}))}r.createEl("button",{text:"Save",cls:"mod-cta"}).addEventListener("click",(()=>{this.plugin.log("CustomizeUIModal",`Saving UI config for trello ID ${n}`),this.plugin.state.updateCustomUI(n,this.newState),this.close()}))}))}}class lt extends et{constructor(e){super(e),this.setInstructions([{command:"",purpose:"Select a Trello list"}])}getSuggestions(e){const t=e.toLowerCase();return this.options.filter((e=>e.name.toLowerCase().includes(t)))}renderSuggestion(e,t){t.setText(e.name)}}class at{constructor(e,t){this.plugin=e,this.cardCache={},this.cardActionsCache={},this.listCache={},this.labelCache={},this.checklistCache={},this.boardCardId=new Ve(null),this.connectedCardId=new Ve(null),this.data=new Ve(t),this.data.pipe(Ne(e.destroy)).subscribe((e=>r(this,void 0,void 0,(function*(){yield this.plugin.saveData(e)}))))}get settings(){return this.data.pipe(ue((e=>e.settings)))}get connectedCards(){return this.data.value.connectedCards}updateSetting(e,t){const n=Object.assign({},this.data.value.settings);n[e]=t,this.data.next(Object.assign(Object.assign({},this.data.value),{settings:n}))}updateConnectedCard(e,t){const n=Object.assign({},this.data.value.connectedCards);t?n[e]=t:delete n[e],this.data.next(Object.assign(Object.assign({},this.data.value),{connectedCards:n}))}updateCustomUI(e,t){const n=Object.assign({},this.data.value.settings.customUi);t?n[e]=t:delete n[e],this.updateSetting("customUi",n)}completedFirstRun(){this.data.next(Object.assign(Object.assign({},this.data.value),{firstRun:!1}))}updateVersion(){this.data.next(Object.assign(Object.assign({},this.data.value),{version:qe.version}))}getSetting(e){return this.data.value.settings[e]}}var ct=f((function(e){return function(e,t,n){var r;this.message=e,this.name="AjaxError",this.xhr=t,this.request=n,this.status=t.status,this.responseType=t.responseType;try{r=function(e){switch(e.responseType){case"json":if("response"in e)return e.response;var t=e;return JSON.parse(t.responseText);case"document":return e.responseXML;default:return"response"in e?e.response:(t=e).responseText}}(t)}catch(e){r=t.responseText}this.response=r}}));function ut(t){var n;return ce(e.requestUrl({url:t.url,method:null!==(n=t.method)&&void 0!==n?n:"GET"})).pipe(ue((e=>{return{status:(t=e).status,responseHeaders:t.headers,response:t.json};var t})))}!function(){function e(e,t){return ct.call(this,"ajax timeout",e,t),this.name="AjaxTimeoutError",this}e.prototype=Object.create(ct.prototype)}();class dt{constructor(e){this.plugin=e,this.token=new Ve(""),this.plugin.state.settings.pipe(Ne(this.plugin.destroy),ue((e=>e.token))).subscribe(this.token)}getBoards(){if(this.plugin.log("TrelloAPI.getBoards",""),""===this.token.value)return xe((()=>Pe.NoToken));return ut({url:this.auth(`${Fe}/1/members/me/boards?fields=name,url`)}).pipe(K((e=>this.handleAPIError(e))),ue((e=>e.response)))}getCardFromBoard(e,t,n=!1,r=12e4){this.plugin.log("TrelloAPI.getCardFromBoard","");const i=this.plugin.state.cardCache[t];return!i||n||(new Date).getTime()-i.timestamp.getTime()>r?this._getCardFromBoard(e,t):(this.plugin.log("TrelloAPI.getCardFromBoard","-> Returning cached value."),ke(i.item))}_getCardFromBoard(e,t){if(""===this.token.value)return xe((()=>Pe.NoToken));return ut({url:this.auth(`${Fe}/1/boards/${e}/cards/${t}`)}).pipe(K((e=>this.handleAPIError(e))),ue((e=>e.response)),$e((e=>{e&&(this.plugin.state.cardCache[e.id]={item:e,timestamp:new Date})})))}getLabelsFromBoard(e,t=!1,n=6e5){this.plugin.log("TrelloAPI.getLabelsFromBoard","");const r=this.plugin.state.labelCache[e];return!r||t||(new Date).getTime()-r.timestamp.getTime()>n?this._getLabelsFromBoard(e):(this.plugin.log("TrelloAPI.getLabelsFromBoard","-> Returning cached value."),ke(r.item))}_getLabelsFromBoard(e){if(""===this.token.value)return xe((()=>Pe.NoToken));return ut({url:this.auth(`${Fe}/1/boards/${e}/labels`)}).pipe(K((e=>this.handleAPIError(e))),ue((e=>e.response)),$e((t=>{this.plugin.state.labelCache[e]={item:t,timestamp:new Date}})))}getListsFromBoard(e){if(this.plugin.log("TrelloAPI.getListsFromBoard",""),""===this.token.value)return xe((()=>Pe.NoToken));return ut({url:this.auth(`${Fe}/1/boards/${e}/lists`)}).pipe(K((e=>this.handleAPIError(e))),ue((e=>e.response)),$e((e=>{e&&e.length>0&&e.forEach((e=>{this.plugin.state.listCache[e.id]={item:e,timestamp:new Date}}))})))}getList(e,t=!1,n=6e5){this.plugin.log("TrelloAPI.getList","");const r=this.plugin.state.listCache[e];return!r||t||(new Date).getTime()-r.timestamp.getTime()>n?this._getList(e):(this.plugin.log("TrelloAPI.getList","-> Returning cached value."),ke(r.item))}_getList(e){if(""===this.token.value)return xe((()=>Pe.NoToken));return ut({url:this.auth(`${Fe}/1/lists/${e}`)}).pipe(K((e=>this.handleAPIError(e))),ue((e=>e.response)),$e((e=>{e&&(this.plugin.state.listCache[e.id]={item:e,timestamp:new Date})})))}getCardsFromBoard(e){if(this.plugin.log("TrelloAPI.getCardsFromBoard",""),""===this.token.value)return xe((()=>Pe.NoToken));return ut({url:this.auth(`${Fe}/1/boards/${e}/cards`)}).pipe(K((e=>this.handleAPIError(e))),ue((e=>e.response)),$e((e=>{e.forEach((e=>{this.plugin.state.cardCache[e.id]={item:e,timestamp:new Date}}))})))}getActionsFromCard(e,t=[Ae.Comment],n=!1,r=6e4){this.plugin.log("TrelloAPI.getActionsFromCard","");const i=this.plugin.state.cardActionsCache[e];return!i||n||(new Date).getTime()-i.timestamp.getTime()>r?this._getActionsFromCard(e,t):(this.plugin.log("TrelloAPI.getActionsFromCard","-> Returning cached value."),ke(i.item))}_getActionsFromCard(e,t=[Ae.Comment]){if(""===this.token.value)return xe((()=>Pe.NoToken));return ut({url:this.auth(`${Fe}/1/cards/${e}/actions?filter=${t.join(",")}`)}).pipe(K((e=>this.handleAPIError(e))),ue((e=>e.response)),$e((t=>{t&&(this.plugin.state.cardActionsCache[e]={item:t,timestamp:new Date})})))}getChecklistsFromCard(e,t=[],n=!1,r=6e4){this.plugin.log("TrelloAPI.getChecklistsFromCard","");const i=t.map((e=>this.plugin.state.checklistCache[e])),o=(new Date).getTime();return!i||n||i.some((e=>void 0===e||o-e.timestamp.getTime()>r))?this._getChecklistsFromCard(e):(this.plugin.log("TrelloAPI.getChecklistsFromCard","-> Returning cached value."),ke(i.map((e=>e.item))))}_getChecklistsFromCard(e){if(""===this.token.value)return xe((()=>Pe.NoToken));return ut({url:this.auth(`${Fe}/1/cards/${e}/checklists`)}).pipe(K((e=>this.handleAPIError(e))),ue((e=>e.response)),$e((e=>{if(e&&e.length>0){const t=new Date;e.forEach((e=>{this.plugin.state.checklistCache[e.id]={item:e,timestamp:t}}))}})))}getChecklist(e,t=!1,n=6e4){this.plugin.log("TrelloAPI.getChecklist","");const r=this.plugin.state.checklistCache[e];return!r||t||(new Date).getTime()-r.timestamp.getTime()>n?this._getChecklist(e):(this.plugin.log("TrelloAPI.getChecklist","-> Returning cached value."),ke(r.item))}_getChecklist(e){if(""===this.token.value)return xe((()=>Pe.NoToken));return ut({url:this.auth(`${Fe}/1/checklists/${e}`)}).pipe(K((e=>this.handleAPIError(e))),ue((e=>e.response)),$e((t=>{t&&(this.plugin.state.checklistCache[e]={item:t,timestamp:new Date})})))}addCommentToCard(e,t){if(this.plugin.log("TrelloAPI.addCommentToCard",""),""===this.token.value)return xe((()=>Pe.NoToken));return ut({url:this.auth(`${Fe}/1/cards/${e}/actions/comments?text=${encodeURIComponent(t)}`),method:"POST"}).pipe(K((e=>this.handleAPIError(e))))}addNewCard(e){if(this.plugin.log("TrelloAPI.addNewCard",""),""===this.token.value)return xe((()=>Pe.NoToken));let t=this.auth(`${Fe}/1/cards`);return t=this.addQueryParam(t,"idList",e.idList),t=this.addQueryParam(t,"name",e.name,!0),t=this.addQueryParam(t,"desc",e.desc,!0),t=this.addQueryParam(t,"due",e.due),t=this.addQueryParam(t,"pos",e.pos),t=this.addQueryParam(t,"idLabels",e.idLabels?e.idLabels.join(","):void 0),ut({url:t,method:"POST"}).pipe(K((e=>this.handleAPIError(e))))}updateCardList(e,t,n=Oe.Top){return this.plugin.log("TrelloAPI.updateCardList",""),this.updateCard({id:e,idList:t,pos:n})}updateCheckItemState(e,t,n){return this.plugin.log("TrelloAPI.updateCheckItemState",""),this.updateCheckItem(e,{id:t,state:n})}updateCard(e){if(this.plugin.log("TrelloAPI.updateCard",""),""===this.token.value)return xe((()=>Pe.NoToken));let t=this.auth(`${Fe}/1/cards/${e.id}`);return t=this.addQueryParam(t,"name",e.name,!0),t=this.addQueryParam(t,"desc",e.desc,!0),t=this.addQueryParam(t,"idBoard",e.idBoard),t=this.addQueryParam(t,"idList",e.idList),t=this.addQueryParam(t,"due",e.due),t=this.addQueryParam(t,"idAttachmentCover",e.idAttachmentCover),e.idLabels&&(t=this.addQueryParam(t,"idLabels",e.idLabels.join(","))),void 0!==e.dueComplete&&(t=this.addQueryParam(t,"dueComplete",e.dueComplete.toString())),ut({url:t,method:"PUT"}).pipe(K((e=>this.handleAPIError(e))),ue((e=>e.response)))}updateCheckItem(e,t){if(this.plugin.log("TrelloAPI.updateCheckItem",""),""===this.token.value)return xe((()=>Pe.NoToken));let n=this.auth(`${Fe}/1/cards/${e}/checkItem/${t.id}`);return n=this.addQueryParam(n,"name",t.name,!0),n=this.addQueryParam(n,"state",t.state,!0),n=this.addQueryParam(n,"idChecklist",t.idChecklist),ut({url:n,method:"PUT"}).pipe(K((e=>this.handleAPIError(e))),ue((e=>e.response)))}auth(e){return`${e}${e.includes("?")?"&":"?"}key=9537467993aefd6dca9ee7788179c298&token=${this.token.value}`}addQueryParam(e,t,n,r=!1){return n?`${e}${e.includes("?")?"&":"?"}${t}=${r?encodeURIComponent(n):n}`:e}handleAPIError(e){return xe((()=>{if(!(e instanceof ct))return Pe.Unknown;switch(e.status){case 401:return Pe.Unauthorized;case 429:return Pe.RateLimit;default:return Pe.Unknown}}))}}class ht extends e.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t,this.boardSelectModal=new Ke(this.plugin.app,this.plugin)}display(){return r(this,void 0,void 0,(function*(){this.plugin.log("TrelloSettings.display","Initializing settings"),this.containerEl.empty(),this.containerEl.createEl("h2",{text:"Obsidian Trello settings."}),this.plugin.state.settings.pipe(Se(1)).subscribe((e=>{this.buildTokenSetting(this.containerEl,e),this.buildUiConfigSetting(this.containerEl),this.buildBoardSelectSetting(this.containerEl),this.buildOpenToSideSetting(this.containerEl,e),this.buildNewCardPositionSetting(this.containerEl,e),this.buildMovedCardPositionSetting(this.containerEl,e),this.buildVerboseLoggingSetting(this.containerEl,e),this.prepopulateTitleConfigSetting(this.containerEl,e),this.openInDesktopSetting(this.containerEl,e)}))}))}buildTokenSetting(t,n){return r(this,void 0,void 0,(function*(){this.plugin.log("TrelloSettings.buildTokenSetting",`-> Adding token setting with initial value ${n.token}`);const r=new DocumentFragment;r.createDiv({cls:"setting-item-description"}).innerHTML='Your API token. <a href="https://trello.com/1/authorize?expiration=never&scope=read,write&response_type=token&name=Obsidian%20Trello%20Token&key=9537467993aefd6dca9ee7788179c298">Generate one</a> then copy it here. This token can be revoked at any time in your Trello account settings.',new e.Setting(t).setName("Trello Token").setDesc(r).addText((e=>{e.setPlaceholder("Enter token").setValue(n.token).onChange((e=>{this.plugin.state.updateSetting("token",e.trim()),this.plugin.view.updateCard()}))}))}))}buildUiConfigSetting(t){this.plugin.log("TrelloSettings.buildConfigSetting","-> Adding UI config setting"),new e.Setting(t).setName("Customize UI").setDesc("Configure which parts of connected trello cards are displayed by default. Can be overridden per note.").addButton((e=>{e.setButtonText("Configure").onClick((()=>{this.plugin.customizeUIModal.source.next(We),this.plugin.customizeUIModal.open()}))}))}openInDesktopSetting(t,n){(e.Platform.isMacOS||e.Platform.isWin)&&(this.plugin.log("TrelloSettings.openInDesktopSetting","-> Adding open in desktop config setting"),new e.Setting(t).setName("Open in Trello desktop").setDesc("Opens cards in Trello desktop application on macOS or Windows").addToggle((e=>{e.setValue(n.openInDesktop).onChange((e=>{this.plugin.state.updateSetting("openInDesktop",e)}))})))}prepopulateTitleConfigSetting(t,n){this.plugin.log("TrelloSettings.buildConfigSetting",`-> Adding prepopulate title setting with initial value ${n.prepopulateTitle}`),new e.Setting(t).setName("Prepopulate Title").setDesc("Populate card title with the note title when creating a new card. Can be overridden when adding a card.").addToggle((e=>{e.setValue(n.prepopulateTitle).onChange((e=>{this.plugin.state.updateSetting("prepopulateTitle",e)}))}))}buildBoardSelectSetting(t){this.plugin.log("TrelloSettings.buildBoardSelectSetting","-> Adding board select setting"),new e.Setting(t).setName("Select Boards").setDesc("These boards will be available to select cards from.").addButton((e=>{e.setButtonText("Select").onClick((()=>{this.boardSelectModal.open()}))}))}buildOpenToSideSetting(t,n){this.plugin.log("TrelloSettings.buildOpenToSideSetting",`-> Adding open to side setting with initial value ${n.openToSide}`),new e.Setting(t).setName("Open to Side").setDesc("Whether the Trello pane should open to the left or right side.").addDropdown((e=>{e.addOption(Le.Right,"Right").addOption(Le.Left,"Left").setValue(n.openToSide).onChange((e=>{this.plugin.state.updateSetting("openToSide",e)}))}))}buildNewCardPositionSetting(t,n){this.plugin.log("TrelloSettings.buildNewCardPositionSetting",`-> Adding new card position setting with initial value ${n.newCardPosition}`),new e.Setting(t).setName("New Card Position").setDesc("Whether newly created cards should be added to the top or bottom of the list by default. Can be overridden when adding a card.").addDropdown((e=>{e.addOption(Oe.Top,"Top").addOption(Oe.Bottom,"Bottom").setValue(n.newCardPosition).onChange((e=>{this.plugin.state.updateSetting("newCardPosition",e)}))}))}buildMovedCardPositionSetting(t,n){this.plugin.log("TrelloSettings.buildMovedCardPositionSetting",`-> Adding moved card position setting with initial value ${n.movedCardPosition}`),new e.Setting(t).setName("Moved Card Position").setDesc("When moving a card from one list to another, should it be moved to the top or bottom of the selected list.").addDropdown((e=>{e.addOption(Oe.Top,"Top").addOption(Oe.Bottom,"Bottom").setValue(n.movedCardPosition).onChange((e=>{this.plugin.state.updateSetting("movedCardPosition",e)}))}))}buildVerboseLoggingSetting(t,n){this.plugin.log("TrelloSettings.buildVerboseLoggingSetting",`-> Adding verbose logging setting with initial value ${n.verboseLogging}`),new e.Setting(t).setName("Verbose Logging").setDesc("Enable this if you're having trouble with the plugin. Logs will be enabled in the console.").addToggle((e=>{e.setValue(n.verboseLogging).onChange((e=>{this.plugin.state.updateSetting("verboseLogging",e)}))}))}}class pt{constructor(e,t,n){this.plugin=e,this.destroy=t,this.update=n,this.bypassActionCache=!1,this.bypassListCache=!1,this.bypassChecklistsCache=!1,this.cardError=null,this.actionsError=null,this.listError=null,this.checklistsError=null,this.connectedId=new Ve(null),this.currentCard=new Ve(null),this.currentActions=new Ve(null),this.currentList=new Ve(null),this.currentChecklists=new Ve(null),this.currentUIConfig=new Ve(null),this.plugin.state.boardCardId.pipe(Ne(this.destroy),$e((e=>{e||(this.cardError=null,this.actionsError=null,this.listError=null,this.currentCard.next(null),this.currentActions.next(null),this.currentList.next(null))})),Ee((e=>null!==e&&""!==e)),Be((e=>{const[t,n]=e.split(";");return this.plugin.log("TrelloViewManager",`-> Got new board/card ID ${t}/${n}`),this.plugin.log("TrelloViewManager","-> Getting card from API/cache."),this.plugin.api.getCardFromBoard(t,n)}))).subscribe({next:e=>{null!==this.currentCard.value&&this.currentCard.value.id!==e.id&&(this.plugin.log("TrelloViewManager","Card changed, resetting extra info."),this.currentActions.next(null),this.currentList.next(null)),this.cardError=null,this.plugin.log("TrelloViewManager","-> Card updated."),this.currentCard.next(e)},error:e=>{this.cardError=e,this.currentCard.next(null)}}),this.plugin.state.connectedCardId.pipe(Ne(this.destroy),$e((e=>{e||(this.connectedId.next(null),this.currentUIConfig.next(null))})),Ee((e=>null!==e&&""!==e)),$e((e=>{this.connectedId.next(e)})),ve((e=>ge([ke(e),this.plugin.state.settings.pipe(ue((e=>e.customUi)))])))).subscribe((([e,t])=>{const n=t[e]?t[e]:t[We];this.currentUIConfig.next(n),this.plugin.log("TrelloViewManager",`Connected card with ${e}`)})),this.currentCard.pipe(Ne(this.destroy),Ee((e=>null!==e)),Be((e=>this.plugin.api.getActionsFromCard(e.id,void 0,this.bypassActionCache))),Ie((()=>{this.bypassActionCache=!1}))).subscribe({next:e=>{this.plugin.log("TrelloViewManager","Actions updated."),this.actionsError=null,this.currentActions.next(e)},error:e=>{this.actionsError=e,this.currentActions.next(null)}}),this.currentCard.pipe(Ne(this.destroy),Ee((e=>null!==e)),Be((e=>this.plugin.api.getList(e.idList,this.bypassListCache))),Ie((()=>{this.bypassListCache=!1}))).subscribe({next:e=>{this.plugin.log("TrelloViewManager","List updated."),this.listError=null,this.currentList.next(e)},error:e=>{this.listError=e,this.currentList.next(null)}}),this.currentCard.pipe(Ne(this.destroy),Ee((e=>null!==e&&null!==e.idChecklists&&e.idChecklists.length>0)),Be((e=>this.plugin.api.getChecklistsFromCard(e.id,e.idChecklists,this.bypassChecklistsCache))),ue((e=>(e.sort(((e,t)=>e.pos<t.pos?-1:1)),e.forEach((e=>{e.checkItems.sort(((e,t)=>e.pos<t.pos?-1:1))})),e))),Ie((()=>{this.bypassChecklistsCache=!1}))).subscribe({next:e=>{this.plugin.log("TrelloViewManager","Checklist updated."),this.checklistsError=null,this.currentChecklists.next(e)},error:e=>{this.checklistsError=e,this.currentChecklists.next(null)}}),this.update.pipe(Ne(this.destroy),Ee((()=>null!==this.currentCard.value)),$e((()=>{this.plugin.log("TrelloViewManager","Refreshing data."),this.bypassActionCache=!0,this.bypassListCache=!0,this.bypassChecklistsCache=!0})),Be((()=>{const e=this.currentCard.value;return this.plugin.api.getCardFromBoard(e.idBoard,e.id,!0)}))).subscribe({next:e=>{this.cardError=null,e&&(this.plugin.log("TrelloViewManager","-> Got updated card."),this.currentCard.next(e))},error:e=>{this.cardError=e,this.currentCard.next(null)}})}moveCard(){if(this.currentCard.value&&this.currentList.value){this.plugin.log("TrelloViewManager.moveCard","Beginning move card flow");const e=this.currentCard.value,t=this.currentList.value;Je({list:this.plugin.api.getListsFromBoard(e.idBoard).pipe(ue((e=>{this.plugin.log("TrelloViewManager.moveCard","-> Marking current list.");const n=e.find((e=>e.id===t.id));return n&&(n.name=`${n.name} (current list)`),e})),me((e=>(this.plugin.log("TrelloViewManager.moveCard","-> Got all lists for board."),this.plugin.listSuggestModal.options=e,this.plugin.listSuggestModal.open(),this.plugin.listSuggestModal.selected))),Se(1),$e((e=>{this.plugin.log("TrelloViewManager.moveCard",`-> Selected list ${e.id}. Updating card.`)}))),position:this.plugin.state.settings.pipe(Se(1),ue((e=>e.movedCardPosition)),$e((e=>{this.plugin.log("TrelloViewManager.moveCard",`-> Moved card position: ${e}`)})))}).pipe(me((({list:t,position:n})=>this.plugin.api.updateCardList(e.id,t.id,n)))).subscribe({next:e=>{this.plugin.log("TrelloViewManager.moveCard","-> Updated card."),this.currentCard.next(e)},error:e=>{Pe.Abort}})}}}class gt extends e.ItemView{constructor(e,t){super(t),this.plugin=e,this.destroy=new ye,this.update=new ye,this.viewManager=new pt(this.plugin,this.destroy,this.update),ge([this.viewManager.currentCard,this.viewManager.currentActions,this.viewManager.currentList,this.viewManager.currentChecklists,this.viewManager.currentUIConfig]).pipe(Ne(this.destroy)).subscribe((([e,t,n,r,i])=>{this.contentEl.empty();const o=[this.viewManager.cardError,this.viewManager.actionsError,this.viewManager.listError];o.some((e=>null!==e))?this.renderEmptyView(this.getWorstError(o)):null===e?this.renderEmptyView(null):this.renderConnectedView(e,t,n,r,i)}))}getDisplayText(){return"Trello"}getViewType(){return je}getIcon(){return Ue.id}onunload(){this.destroy.next(),this.destroy.complete()}updateCard(){this.update.next()}renderPaneContainer(){return this.contentEl.createDiv("trello-pane--container")}renderEmptyView(e){this.plugin.log("TrelloView.renderEmptyView","");const t=this.renderPaneContainer();if(null===e||e===Pe.NoToken)if(t.createEl("h2",{text:"No Trello card connected."}),e===Pe.NoToken){t.createDiv({text:"An API token is required."});t.createEl("button",{text:"Setup Trello",attr:{type:"button"}}).addEventListener("click",(()=>{this.plugin.openTrelloSettings()}))}else{t.createEl("button",{text:"Connect Trello Card",attr:{type:"button"}}).addEventListener("click",(()=>{this.plugin.connectTrelloCard()}))}else if(t.createEl("h2",{text:"Could not reach Trello API."}),e===Pe.RateLimit)t.createDiv({text:ze});else if(e===Pe.Unauthorized){t.createDiv({text:He});t.createEl("button",{text:"Setup Trello",attr:{type:"button"}}).addEventListener("click",(()=>{this.plugin.openTrelloSettings()}))}else t.createDiv({text:Qe})}renderConnectedView(e,t,n,r,i){this.plugin.log("TrelloView.renderConnectedView",""),this.renderHeader(this.contentEl);const o=this.renderPaneContainer();if((null==i?void 0:i.list)||(null==i?void 0:i.title)||(null==i?void 0:i.description)){const t=o.createDiv("trello-pane--card-info");(null==i?void 0:i.list)&&n&&this.renderCardList(n,t),i.title&&this.renderCardTitle(e,t),i.description&&e.desc&&this.renderCardDesc(e,t),i.due&&this.renderCardDue(e,t)}if((null==i?void 0:i.labels)&&e.labels&&e.labels.length>0){const t=o.createDiv("trello-pane--label-section");this.renderLabels(e,t)}if(null==i?void 0:i.comments){const n=o.createDiv("trello-pane--comment-section");this.renderCommentSection(e,t,n)}if((null==i?void 0:i.checklists)&&r&&r.length>0){const t=o.createDiv("trello-pane--checklist-section");this.renderChecklistSection(e.id,r,t)}}renderHeader(e){this.plugin.log("TrelloView.renderHeader","");const t=e.createDiv("nav-header").createDiv("nav-buttons-container");this.renderNavButton(t,"Refresh card","reset",(()=>{this.update.next()})),this.renderNavButton(t,"Link another card","link",(()=>{this.plugin.connectTrelloCard()})),this.renderNavButton(t,"Unlink card","trash",(()=>{this.plugin.disconnectTrelloCard()})),this.renderNavButton(t,"Customize UI","gear",(()=>{this.plugin.customizeUIModal.source.next(this.viewManager.connectedId.value),this.plugin.customizeUIModal.open()}))}renderCardList(t,n){this.plugin.log("TrelloView.renderCardList","");const r=n.createEl("a",{cls:"trello-pane--card-info--list",text:t.name,attr:{"aria-label":"Move card",href:"#"}}),i=r.createSpan();e.setIcon(i,"right-arrow-with-tail"),r.addEventListener("click",(()=>{this.viewManager.moveCard()}))}renderCardTitle(t,n){this.plugin.log("TrelloView.renderCardTitle","");const r=n.createEl("h3",{text:t.name});let i=t.url,o=HTMLAnchorElement.prototype;!0===this.plugin.state.getSetting("openInDesktop")&&(i=t.url.replace("https","trello")),o=e.Platform.isMacOS||e.Platform.isWin?r.createEl("a",{attr:{href:i,"aria-label":"View in Trello Desktop"}}):r.createEl("a",{attr:{href:i,"aria-label":"View on Trello"}}),e.setIcon(o,"navigate-glyph")}renderCardDesc(t,n){this.plugin.log("TrelloView.renderCardDesc","");const r=n.createDiv("trello-card-desc--container"),i=r.createEl("a",{text:"Description",cls:"trello-card-desc--collapse",href:"#"}),o=i.createSpan("trello-card-desc--collapse-icon");e.setIcon(o,"down-chevron-glyph");const s=r.createDiv({cls:"trello-card-desc--desc"});e.MarkdownRenderer.renderMarkdown(t.desc,s,"",this),i.addEventListener("click",(()=>{s.style.maxHeight?(s.style.maxHeight="",e.setIcon(o,"down-chevron-glyph")):(s.style.maxHeight=s.scrollHeight+"px",e.setIcon(o,"up-chevron-glyph"))}))}renderCardDue(e,t){if(this.plugin.log("TrelloView.renderCardDue",""),e.due){const n=new Date(e.due);t.createEl("h3",{text:`Due: ${n.toLocaleDateString(void 0,{weekday:"long",year:"numeric",month:"long",day:"numeric"})}`})}else t.createEl("h3",{text:"No due date"})}renderLabels(e,t){this.plugin.log("TrelloView.renderLabels",""),e.labels.forEach((e=>{if(e.color){t.createDiv({cls:"trello-label-wrapper",attr:{"aria-label":""!==e.name?e.name:null}}).createSpan({cls:`trello-label trello-color--${e.color}`})}}))}renderCommentSection(t,n,r){this.plugin.log("TrelloView.renderCommentSection","");const i=r.createDiv("trello-comment-input--container"),o=i.createDiv({cls:"trello-comment-input--input-container"}).createEl("textarea",{cls:"trello-comment-input--input",attr:{onInput:"this.parentNode.dataset.replicatedValue = this.value",placeholder:"Write a comment..."}});i.createEl("button",{cls:"trello-comment-input--submit",text:"Submit",attr:{type:"button"}}).addEventListener("click",(()=>{o.value&&this.plugin.api.addCommentToCard(t.id,o.value).pipe($e((()=>{o.value=""}))).subscribe((()=>{this.update.next(),new e.Notice("Added comment.")}))})),n&&0!==n.length&&n.forEach((e=>{this.renderComment(e,r)}))}renderComment(t,n){this.plugin.log("TrelloView.renderComment","");const r=n.createDiv("trello-comment--container"),i=r.createDiv("trello-comment--metadata");i.createSpan({text:t.memberCreator.fullName,cls:"trello-comment--creator"}),i.createSpan({text:new Date(t.date).toLocaleString(),cls:"trello-comment--date"});const o=r.createDiv("trello-comment--text-container");e.MarkdownRenderer.renderMarkdown(t.data.text,o,"",this)}renderChecklistSection(e,t,n){this.plugin.log("TrelloView.renderChecklistSection","");const r=n.createDiv("trello-checklist--section"),i=new rt(r);t.forEach((t=>{this.renderChecklist(e,t,i)}))}renderChecklist(e,t,n){this.plugin.log("TrelloView.renderChecklist","");const r=n.addSection(t.name),i=r.titleEl.querySelector(".trello-accordion--title-text"),o=null==i?void 0:i.createSpan({cls:"trello-checklist--accordion-percent"}),s=r.contentEl.createDiv("trello-checklist--progress-container"),l=s.createSpan("trello-checklist--progress-percent"),a=s.createEl("progress",{cls:"trello-checklist--progress",attr:{max:100}});this.updateProgress(t.checkItems,a,l,o);const c=r.contentEl.createEl("ul","trello-checklist--checklist");t.checkItems.forEach(((n,r)=>{const i=`checkitem-${n.id}`,s=c.createEl("li","trello-checklist--checkitem"),u=s.createEl("input",{cls:"trello-checklist--checkitem-input",attr:{type:"checkbox",id:i}});u.checked=n.state===De.Complete,u.addEventListener("change",(i=>{i.preventDefault();let s=De.Complete;u.checked||(s=De.Incomplete),this.plugin.api.updateCheckItemState(e,n.id,s).subscribe((e=>{u.checked=e.state===De.Complete;const n=[...t.checkItems];n[r].state=e.state,this.updateProgress(n,a,l,o),delete this.plugin.state.listCache[t.id]}))})),s.createEl("label",{cls:"trello-checklist--checkitem-label",text:n.name,attr:{for:i}})}))}renderNavButton(t,n,r,i){this.plugin.log("TrelloView.renderNavButton","");const o=t.createDiv({cls:"nav-action-button",attr:{"aria-label":n}});e.setIcon(o,r),o.addEventListener("click",i)}getWorstError(e){this.plugin.log("TrelloView.getWorstError","");let t=null;return e.forEach((e=>{switch(t){case null:case Pe.NoToken:null!==e&&(t=e);break;case Pe.RateLimit:e===Pe.Unauthorized&&(t=e)}})),t}updateProgress(e,t,n,r){this.plugin.log("TrelloView.updateProgress","");const i=e.filter((e=>e.state===De.Complete)),o=e.length>0?Math.round(i.length/e.length*100):0;t.value=o,n.innerText=`${o}%`,r.innerText=`(${i.length}/${e.length})`}}class ft{constructor(e){this.plugin=e}getPropertyValue(e,t){var n;const r=this.plugin.app.metadataCache.getFileCache(t);return null===(n=null==r?void 0:r.frontmatter)||void 0===n?void 0:n[e]}updateOrCreateMeta(e,t,n){return n?ce(this.plugin.app.fileManager.processFrontMatter(n,(n=>{n[e]=t}))):Te}deleteProperty(e,t){return r(this,void 0,void 0,(function*(){if(t)return this.plugin.app.fileManager.processFrontMatter(t,(t=>{void 0!==t[e]&&delete t[e]}))}))}}function vt(e,t){!function(e,t){const n=Ge.customUi[We],r=Object.assign({},t);Object.keys(t).forEach((e=>{r[e]=Object.assign({},n,t[e])})),e.state.updateSetting("customUi",r)}(e,t.settings.customUi),e.state.updateVersion()}let bt=(e=21)=>{let t="",n=crypto.getRandomValues(new Uint8Array(e|=0));for(;e--;)t+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&n[e]];return t};class mt extends e.Plugin{constructor(){super(...arguments),this.yamlHandler=new ft(this),this.destroy=new ye,this.boardSuggestModal=new tt(this.app),this.cardCreateModal=new it(this.app,this),this.cardSuggestModal=new ot(this.app),this.listSuggestModal=new lt(this.app)}onload(){return r(this,void 0,void 0,(function*(){const t=yield this.loadData(),n=Object.assign({},qe,t);n.settings=Object.assign({},Ge,null==t?void 0:t.settings),n.settings.customUi=Object.assign({},Ge.customUi,null==t?void 0:t.settings.customUi),e.Platform.isWin||e.Platform.isMacOS||(n.settings.openInDesktop=!1),this.state=new at(this,n),this.api=new dt(this),this.customizeUIModal=new st(this.app,this),e.addIcon(Ue.id,Ue.svgContent),t&&t.version!==qe.version&&vt(this,n),this.registerView(je,(e=>this.view=new gt(this,e))),this.registerEvent(this.app.workspace.on("file-open",(e=>r(this,void 0,void 0,(function*(){return this.handleFile(e)}))))),this.handleFile(this.app.workspace.getActiveFile()),this.addSettingTab(new ht(this.app,this)),this.addCommand({id:"trello-plugin-connect-card",name:"Connect Trello card",callback:this.connectTrelloCard.bind(this),icon:"link"}),this.addCommand({id:"trello-plugin-disconnect-card",name:"Disconnect Trello card",callback:this.disconnectTrelloCard.bind(this),icon:"trash"}),this.addCommand({id:"trello-plugin-reveal-leaf",name:"Show Trello view",callback:()=>{this.revealTrelloLeaf(!0)},icon:Ue.id}),n.firstRun&&(this.revealTrelloLeaf(!0),this.state.completedFirstRun())}))}onunload(){this.destroy.next(),this.destroy.complete(),this.app.workspace.detachLeavesOfType(je)}openTrelloSettings(){this.log("TrelloPlugin.openTrelloSettings","Opening settings"),this.app.setting.openTabById("obsidian-trello"),this.app.setting.open()}log(e,t,n=_e.Info){if(this.state.getSetting("verboseLogging")){const r=`OBSIDIAN-TRELLO: (${e}) ${t}`;switch(n){case _e.Warn:console.warn(r);break;case _e.Error:console.error(r);break;case _e.Info:default:console.log(r)}}}handleFile(e){return r(this,void 0,void 0,(function*(){if(!e)return;const t=yield this.yamlHandler.getPropertyValue(Ye.BoardCard,e);let n=yield this.yamlHandler.getPropertyValue(Ye.TrelloId,e);if(t&&!n){const r=bt(),[i,o]=t.split(";");yield this.yamlHandler.updateOrCreateMeta(Ye.TrelloId,r,e),this.state.updateConnectedCard(r,{boardId:i,cardId:o}),n=r}if(!t)return this.log("TrelloPlugin.handleFile","File not trello connected"),this.state.boardCardId.next(null),void this.state.connectedCardId.next(null);this.log("TrelloPlugin.handleFile",`File trello connected, board/card ID ${t}, plugin ID ${n}`),this.state.boardCardId.next(t),this.state.connectedCardId.next(n)}))}connectTrelloCard(){const t=this.app.workspace.getActiveFile();if(!t)return void this.log("TrelloPlugin.connectTrelloCard","No file available to connect trello card.",_e.Warn);let n;this.log("TrelloPlugin.connectTrelloCard","Connecting trello card"),this.state.settings.pipe(Se(1),ue((e=>e.selectedBoards)),me((e=>Xe((()=>e.length>0),ke(e),this.api.getBoards()))),$e((()=>{this.log("TrelloPlugin.connectTrelloCard","-> Got boards")})),me((e=>this.selectBoard(e))),$e((e=>{this.log("TrelloPlugin.connectTrelloCard",`-> Selected board ${e.id}`),n=e})),me((e=>this.api.getCardsFromBoard(e.id))),$e((e=>{this.log("TrelloPlugin.connectTrelloCard",`-> Got ${e.length} cards.`)})),me((e=>this.selectCard(e))),$e((e=>{this.log("TrelloPlugin.connectTrelloCard",`-> Selected card ${e.id}`)})),me((e=>Xe((()=>e===Ze),this.addNewCard(n).pipe($e((()=>{this.log("TrelloPlugin.connectTrelloCard","Beginning add new card flow.")}))),ke(e).pipe($e((()=>{this.log("TrelloPlugin.connectTrelloCard","-> Selected existing card")})))))),me((e=>Je({selectedCard:ke(e),existingId:ke(this.yamlHandler.getPropertyValue(Ye.TrelloId,t))}))),ue((({selectedCard:e,existingId:t})=>{const n=t||bt();this.log("TrelloPlugin.connectTrelloCard",`-> Updating file with plugin ID ${n}`),this.state.updateConnectedCard(n,{cardId:e.id,boardId:e.idBoard}),this.state.connectedCardId.next(n);const r=`${e.idBoard};${e.id}`;return this.log("TrelloPlugin.connectTrelloCard",`-> Updating file with board/card ID ${r}`),this.state.boardCardId.next(r),{boardCardId:r,trelloId:n}})),me((({boardCardId:e,trelloId:n})=>function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return be()(ce(e,J(e)))}(this.yamlHandler.updateOrCreateMeta(Ye.TrelloId,n,t).pipe($e((()=>{this.log("TrelloPlugin.connectTrelloCard","-> Adding plugin ID meta key.")}))),this.yamlHandler.updateOrCreateMeta(Ye.BoardCard,e,t).pipe($e((()=>{this.log("TrelloPlugin.connectTrelloCard","-> Adding board/card ID meta key.")}))))))).subscribe({next:()=>{this.log("TrelloPlugin.connectTrelloCard","-> Done connecting card."),this.revealTrelloLeaf(!0)},error:t=>{t===Pe.Abort?this.log("TrelloPlugin.connectTrelloCard","-> Aborting connect flow."):t===Pe.Unauthorized?(this.log("TrelloPlugin.connectTrelloCard","-> API returned unauthorized.",_e.Error),new e.Notice(He)):t===Pe.RateLimit?(this.log("TrelloPlugin.connectTrelloCard","-> API returned rate limit error.",_e.Error),new e.Notice(ze)):t===Pe.NoToken?(this.log("TrelloPlugin.connectTrelloCard","-> No token present.",_e.Error),new e.Notice(Re)):t===Pe.Unknown&&(this.log("TrelloPlugin.connectTrelloCard","-> Caught unknown error.",_e.Error),new e.Notice(Qe))}})}disconnectTrelloCard(){return r(this,void 0,void 0,(function*(){const e=this.app.workspace.getActiveFile();if(!e)return void this.log("TrelloPlugin.disconnectTrelloCard","No file available to connect trello card.",_e.Warn);this.log("TrelloPlugin.disconnectTrelloCard","Disconnecting trello connected card.");const t=this.yamlHandler.getPropertyValue(Ye.TrelloId,e);t&&(yield this.yamlHandler.deleteProperty(Ye.TrelloId,e),this.state.updateConnectedCard(t,null),this.state.connectedCardId.next(null),this.log("TrelloPlugin.disconnectTrelloCard","-> Removed plugin ID.")),yield this.yamlHandler.deleteProperty(Ye.BoardCard,e),this.state.boardCardId.next(null),this.log("TrelloPlugin.disconnectTrelloCard","-> Removed board/card ID.")}))}selectBoard(e){return this.boardSuggestModal.options=e,this.boardSuggestModal.open(),this.boardSuggestModal.selected.pipe(Se(1))}selectCard(e){return this.cardSuggestModal.options=e,this.cardSuggestModal.open(),this.cardSuggestModal.selected.pipe(Se(1))}addNewCard(e){return Je({labels:this.api.getLabelsFromBoard(e.id),list:this.api.getListsFromBoard(e.id).pipe(me((e=>(this.listSuggestModal.options=e,this.listSuggestModal.open(),this.listSuggestModal.selected))),Se(1)),settings:this.state.settings.pipe(Se(1))}).pipe(me((({labels:t,list:n,settings:r})=>(this.log("TrelloPlugin.addNewCard","-> All add new card observables emitted, setting up card create modal."),this.cardCreateModal.board=e,this.cardCreateModal.list=n,this.cardCreateModal.labels=t,this.cardCreateModal.defaultPosition=r.newCardPosition,this.cardCreateModal.open(),this.cardCreateModal.createdCard))),Se(1))}revealTrelloLeaf(e=!1){this.log("TrelloPlugin.revealTrelloLeaf","Revealing trello leaf.");const t=this.app.workspace.getLeavesOfType(je);0===t.length?(this.log("TrelloPlugin.revealTrelloLeaf","-> No trello leaf found, creating."),this.state.settings.pipe(Se(1),ue((e=>e.openToSide))).subscribe((t=>{this.log("TrelloPlugin.revealTrelloLeaf",`-> Creating leaf on ${t} side.`);const n=t===Le.Right?this.app.workspace.getRightLeaf(!1):this.app.workspace.getLeftLeaf(!1);n.setViewState({type:je}),e&&(this.log("TrelloPlugin.revealTrelloLeaf","-> Leaf created, revealing."),this.app.workspace.revealLeaf(n))}))):e&&(this.log("TrelloPlugin.revealTrelloLeaf","-> Trello leaf found, revealing."),this.app.workspace.revealLeaf(t[0]))}}module.exports=mt;

/* nosourcemap */